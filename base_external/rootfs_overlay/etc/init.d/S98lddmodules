#!/bin/sh

case "$1" in
  start)
    echo "S98lddmodules: loading scull, faulty, hello"

    # Load modules (use insmod for scull/faulty; modprobe required for hello)
    insmod /lib/modules/*/extra/scull.ko  >/dev/null 2>&1 || true
    insmod /lib/modules/*/extra/faulty.ko >/dev/null 2>&1 || true
    modprobe hello >/dev/null 2>&1 || true

    # Create device nodes (since helper scripts aren't installed)
    SCULL_MAJOR=$(awk '$2=="scull"{print $1}' /proc/devices)
    FAULTY_MAJOR=$(awk '$2=="faulty"{print $1}' /proc/devices)

    if [ -n "$FAULTY_MAJOR" ] && [ ! -e /dev/faulty ]; then
      mknod /dev/faulty c "$FAULTY_MAJOR" 0
    fi

    # scull usually exposes 4 devices 0-3
    if [ -n "$SCULL_MAJOR" ]; then
      i=0
      while [ $i -lt 4 ]; do
        if [ ! -e "/dev/scull$i" ]; then
          mknod "/dev/scull$i" c "$SCULL_MAJOR" $i
        fi
        i=$((i+1))
      done
    fi
    ;;

  stop)
    echo "S98lddmodules: unloading hello, faulty, scull"

    # Remove device nodes (optional but clean)
    rm -f /dev/faulty /dev/scull0 /dev/scull1 /dev/scull2 /dev/scull3

    rmmod hello  >/dev/null 2>&1 || true
    rmmod faulty >/dev/null 2>&1 || true
    rmmod scull  >/dev/null 2>&1 || true
    ;;

  restart)
    $0 stop
    $0 start
    ;;

  *)
    echo "Usage: $0 {start|stop|restart}"
    exit 1
    ;;
esac

exit 0